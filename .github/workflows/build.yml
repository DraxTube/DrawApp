name: Build PS Vita VPK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: vitasdk/vitasdk:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apk update && apk add --no-cache cmake make git bash

      - name: List available vdpm packages
        run: |
          echo "=== Listing available packages ==="
          vdpm --list || true
          echo "=== VITASDK path ==="
          echo $VITASDK
          ls $VITASDK/arm-vita-eabi/lib/ | head -50 || true

      - name: Install VitaSDK libraries
        run: |
          # Prova i nomi più comuni, ignora errori per pacchetti già presenti
          vdpm libvita2d || vdpm vita2d || echo "vita2d: trying alternative..."
          vdpm libpng || echo "libpng already installed or not found"
          vdpm libjpeg-turbo || vdpm jpeg || echo "jpeg already installed"
          vdpm zlib || echo "zlib already installed"
          vdpm freetype2 || vdpm freetype || echo "freetype already installed"
          # Verifica che libvita2d esista
          echo "=== Checking vita2d ==="
          find $VITASDK -name "*vita2d*" -type f 2>/dev/null || echo "vita2d not found!"
          find $VITASDK -name "*freetype*" -type f 2>/dev/null | head -5

      - name: Build
        run: |
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)

      - name: Upload VPK
        uses: actions/upload-artifact@v4
        with:
          name: DrawApp-vpk
          path: build/*.vpk
